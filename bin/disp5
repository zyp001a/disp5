#!/usr/bin/env node
var d = require("../src");
var fs = require("fs");
var rl = require('readline');
var cmd = process.argv[2];
var arg1 = process.argv[3];
var args = arg1;
for(var i=4; i< process.argv.length; i++){
	args+=" "+process.argv[i];
}
var context = {
	user: process.env.USER,
	lang: "disp"
}
var matched;
if((matched = args.match(/-l\s*(\S+)/))){
	context.outlang = matched[1];
}
switch(cmd){
	case "run":
	case "gen":
	var str = fs.readFileSync(arg1).toString();
	context.code = str;
	if(cmd == "gen"){
		context.gen = {arch: "nodejs", mount: "gen"};
	}
	context.code = ":{ "+context.code+" }";
	d(context);	
	break;

	case "exec":
	context.code = args;
	d(context);
	break;
	
	case "help":
	console.log("Basic usage: disp run [file]");
	break;

	case "shell":
	default:
		shell(context);
}
function shell(context){
	ask(context, function(str){
		var result = d(str);
		if(result)
			process.exit();
		else
			shell(context);
	})
}
function ask(context, cb) {
  var r = rl.createInterface({
    input: process.stdin,
    output: process.stdout});
  r.question(context.user+"@"+ context.lang+ ">", function(answer) {
    r.close();
		cb(answer);
  });
}

